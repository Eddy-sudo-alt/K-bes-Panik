<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title></title>
<style>
  html,body{height:100%;margin:0;background:#000;overflow:hidden;-webkit-tap-highlight-color:transparent}
  .stage{position:fixed;inset:0;padding:env(safe-area-inset-top,0) env(safe-area-inset-right,0) env(safe-area-inset-bottom,0) env(safe-area-inset-left,0)}
  #bg{position:absolute;inset:0;width:100vw;height:100vh;object-fit:cover;object-position:center;user-select:none;pointer-events:none}

  /* Geldanzeige */
  .money{
    position:absolute; top:12px; left:12px; z-index:4;
    background:rgba(0,0,0,.45); color:#ffd700;
    border:1px solid rgba(255,215,0,0.4); border-radius:10px;
    padding:8px 14px; font:600 16px/1.2 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    backdrop-filter: blur(2px); box-shadow:0 2px 6px rgba(0,0,0,0.4);
  }

  /* Top-Buttons rechts */
  .topbtn{position:absolute; top:12px; z-index:4;
    width:42px; height:42px; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.45); color:#ffd700; border:1px solid rgba(255,215,0,.4);
    border-radius:10px; font:22px/1 "Apple Color Emoji","Segoe UI Emoji",system-ui,sans-serif;
    cursor:pointer; user-select:none; box-shadow:0 2px 6px rgba(0,0,0,.4);
  }
  #soundToggle{ right:12px; }
  #assistantToggle{ right:60px; } /* links vom Sound-Icon */
  #assistantToggle.active{ background:rgba(0,128,0,.4); border-color:rgba(120,255,120,.5); }

  /* Effekte (Geld, TIP, Emoji, Malus) */
  .fx{
    position:absolute; z-index:5; font:700 18px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    text-shadow:0 1px 2px rgba(0,0,0,.5); pointer-events:none; opacity:0;
    transform: translate(-50%,0) translateZ(0); animation: rise 900ms ease-out forwards;
    white-space:nowrap;
  }
  .fx.money{ color:#ffd700; font-size:16px; }
  .fx.tip  { color:#56e39f; font-size:16px; }
  .fx.emoji{ font-size:26px; }
  .fx.malus{ color:#ef5350; font-size:16px; }
  @keyframes rise{
    0%{opacity:0;transform:translate(-50%,10px)}
    12%{opacity:1;transform:translate(-50%,0)}
    70%{opacity:1;transform:translate(-50%,-40px)}
    100%{opacity:0;transform:translate(-50%,-60px)}
  }

  /* Level-Up Banner */
  .levelup{
    position:absolute; top:14px; left:50%; transform:translateX(-50%);
    z-index:6; background:rgba(0,0,0,.55); color:#ffd700;
    border:1px solid rgba(255,215,0,.45); border-radius:12px;
    padding:10px 18px; font:700 16px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    box-shadow:0 2px 10px rgba(0,0,0,.5); display:none; animation: pop 900ms ease-out;
  }
  @keyframes pop{
    0%{transform:translateX(-50%) scale(.8);opacity:0}
    25%{transform:translateX(-50%) scale(1.05);opacity:1}
    100%{transform:translateX(-50%) scale(1);opacity:1}
  }

  /* Gl√§ser */
  .glass{
    position:absolute;width:46px;height:70px;border:2px solid #d4aa00;border-radius:6px;
    background:rgba(255,255,255,.04);overflow:hidden;box-shadow:0 0 6px rgba(0,0,0,.55);
    z-index:3;touch-action:manipulation;cursor:pointer; transition:border-color .2s ease;
  }
  .glass.low{border-color:#ffb300}
  .glass.empty{border-color:#ef5350}
  .glass.hidden{display:none}
  .glass.popin{animation:popin .45s ease-out}
  @keyframes popin{
    0%{transform:scale(.7);opacity:0}
    70%{transform:scale(1.08);opacity:1}
    100%{transform:scale(1);opacity:1}
  }
  .fill{position:absolute;left:0;bottom:0;width:100%;height:100%;
    background:linear-gradient(180deg,#f7e17c,#e1b12c);transition:height .22s ease}

  /* Popup (Abmahnungen/K√ºndigung) */
  .popup{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:7}
  .popup-content{background:#1b1f2a;color:#fff;padding:20px 24px;border-radius:10px;text-align:center;max-width:80%;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;box-shadow:0 4px 20px rgba(0,0,0,.6)}
  .popup-content button{margin-top:12px;padding:8px 14px;border:none;border-radius:6px;background:#f6c356;color:#141821;font-weight:bold;cursor:pointer}

  /* Game Over */
  .gameover{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#000;color:#e8ecf1;z-index:8;
    font:700 20px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;text-align:center;padding:24px}
</style>
</head>
<body>
  <div class="stage" id="stage">
    <img id="bg" alt=""
         src="https://raw.githubusercontent.com/Eddy-sudo-alt/K-bes-Panik/refs/heads/main/D865D92A-F21B-4602-A575-BC42B2B79A98.png"/>

    <div class="money" id="money">0,00 ‚Ç¨</div>
    <div class="topbtn" id="assistantToggle" title="Assistent an/aus">ü§ù</div>
    <div class="topbtn" id="soundToggle" title="Sound an/aus">üîä</div>
    <div class="levelup" id="levelup">Level Up ‚Äì Neues Glas!</div>

    <!-- Start-Gl√§ser -->
    <div class="glass" id="g0"><div class="fill"></div></div>
    <div class="glass hidden" id="g1"><div class="fill"></div></div>
    <div class="glass hidden" id="g2"><div class="fill"></div></div>
  </div>

  <!-- Hintergrundsound -->
  <audio id="bgm" src="Tavern.mp3" loop></audio>

  <!-- Popup -->
  <div class="popup" id="popup">
    <div class="popup-content">
      <div id="popupText">Erste Abmahnung</div>
      <button id="popupBtn">OK</button>
    </div>
  </div>

  <!-- Game Over -->
  <div class="gameover" id="gameover">
    Game Over<br/>du musst zum Arbeitsamt.
  </div>

<script>
/* ========== Einstellungen ========== */
const START_POS = [
  { x:53, y:69 }, // Glas 1
  { x:71, y:62 }, // Glas 2
  { x:65, y:56 }  // Glas 3
];
// Zufallsbereich f√ºr neue Gl√§ser (in % der Bildfl√§che, sicher im Tischbereich)
const RAND_BOX = { xMin: 22, xMax: 88, yMin: 55, yMax: 82 };

const BASE_EURO = 0.25;
const TIP_RATE = 0.10; // +10%
const UNLOCK_2 = 3;    // 3 gute Fills gesamt ‚Üí Glas 2
const UNLOCK_3 = 6;    // 6 gute Fills gesamt ‚Üí Glas 3
const UNLOCK_STEP = 3; // ab dann: alle +3 guten Fills ‚Üí neues Glas
/* ================================== */

const stage = document.getElementById('stage');
const bg = document.getElementById('bg');
const moneyEl = document.getElementById('money');
const levelEl = document.getElementById('levelup');
const popup = document.getElementById('popup');
const popupText = document.getElementById('popupText');
const popupBtn = document.getElementById('popupBtn');
const gameover = document.getElementById('gameover');

/* Sounds */
const sFill = new Audio('fill.mp3'); sFill.volume = 0.6;
const bgm = document.getElementById('bgm'); bgm.volume = 0.5;
bgm.play().catch(()=>{});
document.addEventListener('pointerdown', () => { if (bgm.paused) bgm.play().catch(()=>{}); }, { once: true, passive: true });

/* Sound Toggle */
const soundToggle = document.getElementById('soundToggle');
function updateSoundIcon(){ soundToggle.textContent = (bgm.muted || bgm.volume === 0) ? 'üîá' : 'üîä'; }
soundToggle.addEventListener('click', ()=>{ bgm.muted = !bgm.muted; updateSoundIcon(); });

/* Assistent (Einnahmen halbiert) */
let assistantOn = false;
const assistantToggle = document.getElementById('assistantToggle');
function updateAssistantIcon(){ assistantToggle.classList.toggle('active', assistantOn); }
assistantToggle.addEventListener('click', ()=>{
  assistantOn = !assistantOn;
  updateAssistantIcon();
});

/* Geld */
let money = 0;
function euro(v){ return v.toFixed(2).replace('.', ',') + ' ‚Ç¨'; }
function updateMoney(){ moneyEl.textContent = euro(money); }

/* Abmahnungen global */
let strikes = 0;
let ended = false;

/* Fortschritt kumulativ (gute Fills = unteres Drittel) */
let progressGoodFills = 0;

/* Effekte */
function spawnFx(text, className, x, y){
  const s = document.createElement('div');
  s.className = 'fx ' + className;
  s.textContent = text;
  s.style.left = x + 'px';
  s.style.top  = y + 'px';
  document.body.appendChild(s);
  requestAnimationFrame(()=>{
    const r = s.getBoundingClientRect(), M = 10;
    if (r.right > innerWidth - M) s.style.left = (parseFloat(s.style.left)- (r.right-(innerWidth-M))) + 'px';
    if (r.left < M) s.style.left = (parseFloat(s.style.left)+ (M-r.left)) + 'px';
  });
  setTimeout(()=>s.remove(), 950);
}
function triFx(glassEl, {moneyTxt, tipTxt, emojiTxt, malusTxt}){
  const r = glassEl.getBoundingClientRect();
  const cx = r.left + r.width/2;
  const cy = r.top  + r.height*0.15;
  const dx = 62, dyTop = 34, dyRow = 14;
  if (moneyTxt) spawnFx(moneyTxt, 'money', cx - dx, cy - dyRow);
  if (tipTxt)   spawnFx(tipTxt,   'tip',   cx + dx, cy - dyRow);
  if (emojiTxt) spawnFx(emojiTxt, 'emoji', cx,      cy - dyTop);
  if (malusTxt) spawnFx(malusTxt, 'malus', cx,      cy);
}

/* Tools */
function rand(min,max){ return min + Math.random()*(max-min); }
function randi(min,max){ return Math.floor(rand(min,max+1)); }

/* Glas-Objekte */
const glasses = [];   // dynamisch wachsend
const posPerc = [];   // Prozent-Positionen, passend zur Cover-Logik

/* Glas erstellen (DOM + Logik) */
function addGlass(posPercent){
  // DOM erzeugen
  const el = document.createElement('div');
  el.className = 'glass';
  const fill = document.createElement('div');
  fill.className = 'fill';
  el.appendChild(fill);
  stage.appendChild(el);

  // Geschwindigkeit: mit steigender Anzahl leicht schneller
  const idx = glasses.length;
  const baseMin = 4 + Math.min(idx,6)*0.4; // w√§chst ein wenig
  const baseMax = 6 + Math.min(idx,6)*0.6;
  const g = {
    idx, el, fillEl: fill, pct: 100,
    speed: rand(baseMin, baseMax), jitter: 0,
    warnedThisCycle: false, active: true
  };
  el.addEventListener('pointerdown', ()=>handleFill(g));
  glasses.push(g);
  posPerc.push(posPercent);
  positionOne(g);
  render(g);
  el.classList.add('popin'); setTimeout(()=>el.classList.remove('popin'), 500);
  return g;
}

/* Start-Gl√§ser vorbereiten (3 fixe) */
function initStartGlasses(){
  // vorhandene 3 HTML-Gl√§ser in Array √ºbernehmen
  ['g0','g1','g2'].forEach((id,i)=>{
    const el = document.getElementById(id);
    const g = {
      idx: i, el, fillEl: el.querySelector('.fill'), pct: 100,
      speed: rand(4 + i*0.8, 6 + i*1.0), jitter: 0,
      warnedThisCycle: false, active: !el.classList.contains('hidden')
    };
    el.addEventListener('pointerdown', ()=>handleFill(g));
    glasses.push(g);
    posPerc.push(START_POS[i]);
  });
}
initStartGlasses();

/* Positionierung exakt √ºber cover-Bild */
function positionOne(g){
  const i = g.idx;
  const sw = stage.clientWidth, sh = stage.clientHeight;
  const iw = bg.naturalWidth || 1024, ih = bg.naturalHeight || 1024;
  const scale = Math.max(sw/iw, sh/ih);
  const dw = iw*scale, dh = ih*scale;
  const offX = (sw-dw)/2, offY = (sh-dh)/2;
  const p = posPerc[i];
  const w = g.el.offsetWidth, h = g.el.offsetHeight;
  const x = offX + (p.x/100)*dw;
  const y = offY + (p.y/100)*dh;
  g.el.style.left = (x - w/2) + 'px';
  g.el.style.top  = (y - h*0.65) + 'px';
}
function positionGlasses(){
  glasses.forEach(positionOne);
}
if (bg.complete) positionGlasses(); else bg.addEventListener('load', positionGlasses);
addEventListener('resize', positionGlasses, {passive:true});
addEventListener('orientationchange', positionGlasses, {passive:true});

/* Render */
function render(g){
  g.fillEl.style.height = g.pct + '%';
  g.el.classList.toggle('low',   g.pct <= 35 && g.pct > 0);
  g.el.classList.toggle('empty', g.pct <=  0);
}

/* Level-Up Banner */
function showBanner(txt='Level Up ‚Äì Neues Glas!'){
  levelEl.textContent = txt;
  levelEl.style.display = 'block';
  setTimeout(()=> levelEl.style.display = 'none', 1200);
}

/* Unlocks */
function maybeUnlock(){
  // Glas 2 (Index 1) und 3 (Index 2) per vorhandenen HTML-Containern
  if (!glasses[1].active && progressGoodFills >= UNLOCK_2){
    glasses[1].el.classList.remove('hidden');
    glasses[1].active = true; showBanner();
  }
  if (!glasses[2].active && progressGoodFills >= UNLOCK_3){
    glasses[2].el.classList.remove('hidden');
    glasses[2].active = true; showBanner();
  }
  // Ab Glas 4: bei 9,12,15,‚Ä¶ (alle +3)
  const needForNext = UNLOCK_3 + UNLOCK_STEP * Math.max(0, glasses.length - 3);
  if (progressGoodFills >= needForNext){
    // Zuf√§llige Position innerhalb des sicheren Bereichs
    const p = {
      x: randi(RAND_BOX.xMin, RAND_BOX.xMax),
      y: randi(RAND_BOX.yMin, RAND_BOX.yMax)
    };
    addGlass(p);
    showBanner('Neues Glas!');
  }
}

/* Popup */
function showPopup(text){ popupText.textContent = text; popup.style.display = 'flex'; }
function hidePopup(){ popup.style.display = 'none'; }
popupBtn.addEventListener('click', ()=>{
  if (strikes >= 3){ hidePopup(); gameover.style.display='flex'; ended=true; }
  else hidePopup();
});

/* Auff√ºllen ‚Äì Sound SOFORT, dann Logik & Effekte */
function handleFill(g){
  if (ended) return;

  try { sFill.currentTime = 0; sFill.play(); } catch(_) {}

  const prev = g.pct;
  g.pct = 100; g.warnedThisCycle = false;

  // Auszahlungen & Status
  let addBase = BASE_EURO; // immer
  let tipAdd  = 0;
  let emoji   = '';
  let malus   = '';

  if (prev <= 33){        // Unteres Drittel ‚Üí Bonus + Fortschritt +1
    emoji = 'üòÄ';
    tipAdd = BASE_EURO * TIP_RATE;
    progressGoodFills++;
  } else if (prev <= 66){ // Mitte ‚Üí neutral
    emoji = 'üòê';
  } else {                // Oberes Drittel ‚Üí Malus ‚àí1 Fortschritt
    emoji = 'üò†';
    if (progressGoodFills > 0) { progressGoodFills--; malus = 'Fortschritt ‚àí1'; }
  }

  // Assistent nimmt 50% Anteil
  const share = assistantOn ? 0.5 : 1;
  money += (addBase + tipAdd) * share;
  updateMoney();

  // Effekte: Geld/TIP/Emoji/Malus
  const moneyTxt = '+' + euro(addBase * share).replace(' ‚Ç¨',' ‚Ç¨');
  const tipTxt   = tipAdd > 0 ? 'TIP +' + euro(tipAdd * share).replace(' ‚Ç¨',' ‚Ç¨') : null;
  const malusTxt = malus || null;
  triFx(g.el, {moneyTxt, tipTxt, emojiTxt: emoji, malusTxt});

  maybeUnlock();
  render(g);
}

/* Entleerung + Assistent */
let last = performance.now();
function jitterLoop(g){
  g.jitter = (Math.random()*0.4 - 0.2) * g.speed;
  setTimeout(()=>jitterLoop(g), 7000 + Math.random()*5000);
}

/* Assistent f√ºllt automatisch nach, wenn ‚â§30% */
function assistantTick(){
  if (!assistantOn || ended) return;
  glasses.forEach(g=>{
    if (!g.active) return;
    if (g.pct <= 30){
      // kleine Reaktionszeit f√ºr Fairness
      setTimeout(()=>{ if (g.pct <= 30) handleFill(g); }, randi(250, 400));
    }
  });
}

glasses.forEach(jitterLoop);

function loop(now){
  if (ended) return;
  const dt = Math.min(1000, now-last)/1000; last = now;

  glasses.forEach(g=>{
    if (!g.active) return;
    g.pct = Math.max(0, g.pct - Math.max(0, g.speed + g.jitter) * dt);

    if (g.pct <= 0 && !g.warnedThisCycle){
      g.warnedThisCycle = true;
      strikes++;
      if (strikes === 1) showPopup('Erste Abmahnung');
      else if (strikes === 2) showPopup('Zweite Abmahnung');
      else if (strikes >= 3) showPopup('K√ºndigung');
    }
    render(g);
  });

  assistantTick(); // Assistent pr√ºfen
  requestAnimationFrame(loop);
}

/* Start */
updateMoney();
positionGlasses();
updateSoundIcon();
updateAssistantIcon();
requestAnimationFrame(loop);
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title></title>
  <style>
    html,body{height:100%;margin:0;background:#000;overflow:hidden;-webkit-tap-highlight-color:transparent}
    .stage{position:fixed;inset:0;padding:env(safe-area-inset-top,0) env(safe-area-inset-right,0) env(safe-area-inset-bottom,0) env(safe-area-inset-left,0)}
    #bg{position:absolute;inset:0;width:100vw;height:100vh;object-fit:cover;object-position:center;user-select:none;pointer-events:none}

    /* HUD: 8h-Timer */
    .hud{
      position:absolute; top:12px; right:12px; z-index:3;
      background:rgba(0,0,0,.45); color:#e8ecf1; border:1px solid rgba(255,255,255,.2);
      border-radius:10px; padding:8px 12px; font:600 14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      backdrop-filter: blur(2px);
    }

    /* Glas */
    .glass{
      position:absolute;width:46px;height:70px;border:2px solid #d4aa00;border-radius:6px;
      background:rgba(255,255,255,.04);overflow:hidden;box-shadow:0 0 6px rgba(0,0,0,.55);
      z-index:2;touch-action:manipulation;cursor:pointer
    }
    .glass.low{border-color:#ffb300}
    .glass.empty{border-color:#ef5350}
    .fill{position:absolute;left:0;bottom:0;width:100%;height:100%;background:linear-gradient(180deg,#f7e17c,#e1b12c);transition:height .22s ease}

    /* Popup Abmahnung */
    .popup{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.5); z-index:5;
    }
    .popup-content{
      background:#1b1f2a; color:#fff; padding:20px 24px; border-radius:10px; text-align:center;
      max-width:80%; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      box-shadow:0 4px 20px rgba(0,0,0,0.6);
    }
    .popup-content button{
      margin-top:12px; padding:8px 14px; border:none; border-radius:6px;
      background:#f6c356; color:#141821; font-weight:bold; cursor:pointer;
    }

    /* Game Over: schwarzer Bildschirm */
    .gameover{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:#000; color:#e8ecf1; z-index:6;
      font:700 20px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      text-align:center; padding:24px;
    }
  </style>
</head>
<body>
  <div class="stage" id="stage">
    <img id="bg" alt=""
         src="https://raw.githubusercontent.com/Eddy-sudo-alt/K-bes-Panik/refs/heads/main/D865D92A-F21B-4602-A575-BC42B2B79A98.png"/>

    <div class="hud"><span id="timer">08:00:00</span></div>

    <!-- Ein einziges Glas -->
    <div class="glass" id="g1"><div class="fill"></div></div>
  </div>

  <!-- Abmahnungs-Popup -->
  <div class="popup" id="popup">
    <div class="popup-content">
      <div id="popupText">Erste Abmahnung</div>
      <button id="popupBtn">OK</button>
    </div>
  </div>

  <!-- Spielende -->
  <div class="gameover" id="gameover">
    Du musst zum Arbeitsamt.
  </div>

  <script>
    // Position (etwas höher gesetzt)
    const point = { x: 53, y: 69 };

    // Glas-Status
    const g = {
      el: document.getElementById('g1'),
      fillEl: document.querySelector('#g1 .fill'),
      pct: 100,
      speed: 4.2,   // % pro Sekunde (nur leeren)
      jitter: 0,
      warnedThisCycle: false // wurde in diesem „Leer-Lauf“ schon gezählt?
    };

    // Abmahnungen / Spielende
    let strikes = 0;
    let ended = false;

    const popup = document.getElementById('popup');
    const popupText = document.getElementById('popupText');
    const popupBtn = document.getElementById('popupBtn');
    const gameover = document.getElementById('gameover');

    function showPopup(text){
      popupText.textContent = text;
      popup.style.display = 'flex';
    }
    popupBtn.addEventListener('click', ()=> { popup.style.display = 'none'; });

    function gameOver(){
      ended = true;
      // Alles visuell anhalten
      gameover.style.display = 'flex';
    }

    // Tippen/Klicken -> füllt und setzt Zyklus zurück
    const fillUp = ()=>{
      if (ended) return;
      g.pct = 100;
      g.warnedThisCycle = false; // neuer Zyklus beginnt
      render();
    };
    g.el.addEventListener('click', fillUp);
    g.el.addEventListener('touchend', fillUp, {passive:true});

    // Entleerungs-Loop
    let last = performance.now();
    function loop(now){
      if (ended) return; // nichts mehr tun
      const dt = Math.min(1000, now - last) / 1000; last = now;

      if (!isTimerDone()){
        const eff = Math.max(0, g.speed + g.jitter);
        g.pct = Math.max(0, g.pct - eff * dt);
        // Abmahnung nur einmal pro Leer-Zyklus auslösen
        if (g.pct <= 0 && !g.warnedThisCycle){
          g.warnedThisCycle = true;
          strikes++;
          if (strikes === 1)      showPopup('Erste Abmahnung');
          else if (strikes === 2) showPopup('Zweite Abmahnung');
          else if (strikes >= 3)  gameOver();
        }
        render();
      }
      requestAnimationFrame(loop);
    }

    function render(){
      g.fillEl.style.height = g.pct + '%';
      g.el.classList.toggle('low',   g.pct <= 35 && g.pct > 0);
      g.el.classList.toggle('empty', g.pct <=  0);
    }

    // kleine zufällige Schwankungen
    function reshuffleJitter(){
      if (ended) return;
      g.jitter = (Math.random()*0.4 - 0.2) * g.speed; // ±20 %
      setTimeout(reshuffleJitter, 7000 + Math.random()*5000);
    }
    reshuffleJitter();

    // 8h-Countdown (persistiert)
    const DURATION_MS = 8 * 60 * 60 * 1000;
    const LS_KEY_START = 'koebes_timer_start';
    const timerEl = document.getElementById('timer');
    function getStart(){ const v = localStorage.getItem(LS_KEY_START); return v ? parseInt(v,10) : null; }
    function ensureStart(){ let t=getStart(); if(!t){ t=Date.now(); localStorage.setItem(LS_KEY_START,String(t)); } return t; }
    function isTimerDone(){ const start = ensureStart(); return Date.now() - start >= DURATION_MS; }
    function updateTimer(){
      if (ended) return;
      const start = ensureStart();
      let remain = Math.max(0, DURATION_MS - (Date.now() - start));
      const h = Math.floor(remain/3600000); remain %= 3600000;
      const m = Math.floor(remain/60000);   remain %= 60000;
      const s = Math.floor(remain/1000);
      timerEl.textContent = String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
      requestAnimationFrame(updateTimer);
    }

    // Exakte Position auf dem Bild (object-fit: cover)
    const stage = document.getElementById('stage');
    const bg = document.getElementById('bg');
    function positionGlass(){
      const sw = stage.clientWidth, sh = stage.clientHeight;
      const iw = bg.naturalWidth || 1024, ih = bg.naturalHeight || 1024;
      const scale = Math.max(sw/iw, sh/ih);
      const dw = iw*scale, dh = ih*scale;
      const offX = (sw - dw)/2, offY = (sh - dh)/2;
      const w = g.el.offsetWidth, h = g.el.offsetHeight;
      const x = offX + (point.x/100)*dw;
      const y = offY + (point.y/100)*dh;
      g.el.style.left = (x - w/2) + 'px';
      g.el.style.top  = (y - h*0.65) + 'px';
    }
    if (bg.complete) positionGlass(); else bg.addEventListener('load', positionGlass);
    addEventListener('resize', positionGlass, {passive:true});
    addEventListener('orientationchange', positionGlass, {passive:true});

    // Start
    requestAnimationFrame(loop);
    requestAnimationFrame(updateTimer);
  </script>
</body>
</html>
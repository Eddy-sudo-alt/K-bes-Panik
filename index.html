<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>K√∂bes Panik</title>
<style>
html,body{height:100%;margin:0;background:#000;overflow:hidden;-webkit-tap-highlight-color:transparent}
.stage{position:fixed;inset:0}
#bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;pointer-events:none}

/* HUD */
.money{
  position:absolute; top:12px; left:12px; z-index:5;
  background:rgba(0,0,0,.5); color:#ffd700; padding:6px 12px;
  border-radius:8px; font:600 16px system-ui; user-select:none;
}
.topbar{
  position:absolute; top:12px; right:12px; z-index:5;
  display:flex; gap:8px;
}
.btn{
  width:42px; height:42px; display:flex; align-items:center; justify-content:center;
  background:rgba(0,0,0,.5); border-radius:8px; font-size:22px; cursor:pointer;
  user-select:none;
}

/* Energie-Balken */
.energybar{
  position:absolute; top:60px; left:12px; width:140px; height:18px; background:#400;
  border-radius:6px; overflow:hidden; z-index:5;
}
.energyfill{
  width:100%; height:100%; background:linear-gradient(90deg,#0f0,#ff0,#f00);
  transition:width 0.2s linear;
}

/* Gl√§ser */
.glass{
  position:absolute; width:46px; height:70px;
  border:2px solid #d4aa00; border-radius:6px;
  background:rgba(255,255,255,.04); overflow:hidden;
  box-shadow:0 0 6px rgba(0,0,0,.55);
  cursor:pointer;
}
.fill{
  position:absolute; left:0; bottom:0; width:100%;
  background:linear-gradient(180deg,#f7e17c,#e1b12c);
  height:100%; transition:height 0.2s ease;
}

/* Effekte */
.fx{
  position:absolute; z-index:10; font:700 16px system-ui;
  text-shadow:0 1px 2px rgba(0,0,0,.5);
  pointer-events:none; animation: rise 0.9s ease-out forwards;
}
.fx.money{color:#ffd700}
.fx.tip{color:#56e39f}
.fx.emoji{font-size:22px}
@keyframes rise{
  0%{opacity:0;transform:translate(-50%,10px)}
  10%{opacity:1;transform:translate(-50%,0)}
  80%{opacity:1;transform:translate(-50%,-30px)}
  100%{opacity:0;transform:translate(-50%,-50px)}
}

/* Popup */
.popup{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:rgba(0,0,0,.5); z-index:20;
}
.popup-content{
  background:#1b1f2a; color:#fff; padding:20px; border-radius:10px;
  text-align:center; max-width:80%;
}
.popup-content button{
  margin-top:12px; padding:8px 14px; border:none; border-radius:6px;
  background:#f6c356; color:#141821; font-weight:bold; cursor:pointer;
}

/* Game Over */
.gameover{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:#000; color:#fff; font:700 20px system-ui; z-index:30;
}
</style>
</head>
<body>
<div class="stage" id="stage">
  <img id="bg" src="bg.PNG" alt="">

  <div class="money" id="money">0,00 ‚Ç¨</div>
  <div class="topbar">
    <div class="btn" id="foodBtn">üçΩ</div>
    <div class="btn" id="drinkBtn">üç∫</div>
    <div class="btn" id="smokeBtn">üö¨</div>
    <div class="btn" id="assistantBtn">ü§ù</div>
    <div class="btn" id="soundBtn">üîä</div>
  </div>

  <div class="energybar"><div class="energyfill" id="energyFill"></div></div>
</div>

<!-- Popup -->
<div class="popup" id="popup">
  <div class="popup-content">
    <div id="popupText">Erste Abmahnung</div>
    <button id="popupBtn">OK</button>
  </div>
</div>

<!-- Game Over -->
<div class="gameover" id="gameover">Game Over<br>Du musst zum Arbeitsamt.</div>

<audio id="bgm" src="Tavern.mp3" loop></audio>
<audio id="fillSound" src="fill.mp3"></audio>

<script>
const BASE_EURO=0.25, TIP_RATE=0.1;
const stage=document.getElementById('stage');
const moneyEl=document.getElementById('money');
const energyFill=document.getElementById('energyFill');
const popup=document.getElementById('popup'), popupText=document.getElementById('popupText'), popupBtn=document.getElementById('popupBtn');
const gameover=document.getElementById('gameover');
const bgm=document.getElementById('bgm'), fillSound=document.getElementById('fillSound');

let money=0, strikes=0, progressGoodFills=0, ended=false;
let assistant=false, energy=100;
let glasses=[];

function euro(v){return v.toFixed(2).replace('.',',')+' ‚Ç¨';}
function updateMoney(){moneyEl.textContent=euro(money);}
function updateEnergy(){
  energyFill.style.width=energy+'%';
  if(energy<=0){ endGame("Du bist im Krankenhaus!"); }
}
function spawnFx(txt,cls,x,y){
  const el=document.createElement('div');
  el.className='fx '+cls; el.textContent=txt;
  el.style.left=x+'px'; el.style.top=y+'px';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),900);
}
function addGlass(x,y){
  const el=document.createElement('div'); el.className='glass';
  const fill=document.createElement('div'); fill.className='fill'; el.appendChild(fill);
  stage.appendChild(el);
  el.style.left=x+'px'; el.style.top=y+'px';
  const g={el,fill,pct:100,speed:Math.random()*2+4,warned:false};
  el.addEventListener('click',()=>handleFill(g));
  glasses.push(g);
}
function randomPos(){
  let x,y;
  do{
    x=Math.random()*(window.innerWidth-50);
    y=Math.random()*(window.innerHeight-120)+80;
  }while(glasses.some(g=>Math.hypot(parseInt(g.el.style.left)-x, parseInt(g.el.style.top)-y)<70));
  return {x,y};
}
function handleFill(g){
  if(ended)return;
  fillSound.currentTime=0; fillSound.play();
  const prev=g.pct;
  g.pct=100; g.warned=false;
  let addBase=BASE_EURO, tipAdd=0, emoji='';
  if(prev<=33){emoji='üòÄ';tipAdd=BASE_EURO*TIP_RATE;progressGoodFills++;}
  else if(prev<=66){emoji='üòê';}
  else {emoji='üò†'; if(progressGoodFills>0)progressGoodFills--;}
  const share=assistant?0.5:1;
  money+=(addBase+tipAdd)*share;
  updateMoney();
  const r=g.el.getBoundingClientRect();
  spawnFx('+'+euro(addBase*share),'money',r.left+20,r.top);
  if(tipAdd>0)spawnFx('TIP +'+euro(tipAdd*share),'tip',r.left+60,r.top);
  spawnFx(emoji,'emoji',r.left+40,r.top-20);
  if(progressGoodFills>=3 && glasses.length<3) {let p=randomPos();addGlass(p.x,p.y);}
  else if(progressGoodFills>0 && progressGoodFills%3===0){let p=randomPos();addGlass(p.x,p.y);}
}
function loop(){
  if(ended)return;
  glasses.forEach(g=>{
    g.pct-=g.speed*0.016;
    if(g.pct<0)g.pct=0;
    g.fill.style.height=g.pct+'%';
    if(g.pct<=0 && !g.warned){
      g.warned=true; strikes++;
      if(strikes===1)showPopup("Erste Abmahnung");
      else if(strikes===2)showPopup("Zweite Abmahnung");
      else if(strikes>=3)endGame("K√ºndigung");
    }
    if(assistant && g.pct<=30)handleFill(g);
  });
  energy-=0.005;
  updateEnergy();
  requestAnimationFrame(loop);
}
function showPopup(txt){popupText.textContent=txt;popup.style.display='flex';}
popupBtn.onclick=()=>popup.style.display='none';
function endGame(txt){ended=true;gameover.innerHTML=txt;gameover.style.display='flex';}

document.getElementById('assistantBtn').onclick=()=>assistant=!assistant;
document.getElementById('foodBtn').onclick=()=>{if(money>=1){money-=1;updateMoney();energy=Math.min(100,energy+15);updateEnergy();}};
document.getElementById('drinkBtn').onclick=()=>{if(money>=1){money-=1;updateMoney();energy=Math.min(100,energy+10);updateEnergy();}};
document.getElementById('smokeBtn').onclick=()=>{if(money>=1){money-=1;updateMoney();energy=Math.min(100,energy+5);updateEnergy();}};
document.getElementById('soundBtn').onclick=()=>{bgm.muted=!bgm.muted;};

bgm.play().catch(()=>{});
updateMoney();updateEnergy();
let p=randomPos();addGlass(p.x,p.y);
requestAnimationFrame(loop);
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>K√∂bes Panik</title>
<style>
html,body{
  margin:0;
  padding:0;
  height:100%;
  background:#000;
  overflow:hidden;
  -webkit-tap-highlight-color: transparent;
}
.stage{position:relative;width:100%;height:100%;}
#bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}

.money{
  position:absolute;top:10px;left:10px;
  background:rgba(0,0,0,.5);color:#ffd700;
  padding:6px 10px;border-radius:6px;
  font:600 16px system-ui;z-index:5;
}
.energy{
  position:absolute;top:40px;left:10px;width:120px;height:14px;
  background:#300;border-radius:6px;overflow:hidden;z-index:5;
}
.energy-fill{
  height:100%;width:100%;background:linear-gradient(90deg,green,yellow,red);
}
.controls{
  position:absolute;top:10px;right:10px;display:flex;flex-direction:row;gap:6px;z-index:5;
}
.controls .btn{
  width:40px;height:40px;background:rgba(0,0,0,.5);
  display:flex;align-items:center;justify-content:center;
  border-radius:6px;cursor:pointer;
  font-size:20px;
}
.glass{
  position:absolute;width:46px;height:70px;
  border:2px solid #d4aa00;border-radius:6px;
  background:rgba(255,255,255,.05);
  overflow:hidden;box-shadow:0 0 6px rgba(0,0,0,.55);
  cursor:pointer;
}
.fill{position:absolute;left:0;bottom:0;width:100%;height:100%;
  background:linear-gradient(180deg,#f7e17c,#e1b12c);transition:height .2s;
}
.fx{
  position:absolute;font:700 16px system-ui;pointer-events:none;
  animation:rise 1s ease-out forwards;white-space:nowrap;
}
.fx.money{color:#ffd700;}
.fx.tip{color:#56e39f;}
.fx.emoji{font-size:24px;}
@keyframes rise{
  0%{opacity:0;transform:translate(-50%,10px)}
  20%{opacity:1;transform:translate(-50%,0)}
  100%{opacity:0;transform:translate(-50%,-50px)}
}
.popup{
  position:fixed;inset:0;display:none;
  background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:10;
}
.popup-content{
  background:#222;color:#fff;padding:20px;border-radius:8px;text-align:center;
}
.popup-content button{
  margin-top:10px;padding:6px 12px;background:#ffd700;border:none;border-radius:6px;font-weight:bold;cursor:pointer;
}
.gameover{
  position:fixed;inset:0;display:none;
  background:#000;color:#fff;font:700 20px system-ui;align-items:center;justify-content:center;z-index:11;
}
</style>
</head>
<body>
<div class="stage" id="stage">
  <img id="bg" src="bg.PNG" alt="">
  <div class="money" id="money">0,00 ‚Ç¨</div>
  <div class="energy"><div class="energy-fill" id="energyFill"></div></div>
  <div class="controls">
    <div class="btn" id="eatBtn">üçñ</div>
    <div class="btn" id="smokeBtn">üö¨</div>
    <div class="btn" id="drinkBtn">üç∫</div>
    <div class="btn" id="assistBtn">ü§ù</div>
    <div class="btn" id="soundBtn">üîä</div>
  </div>
</div>

<audio id="bgm" src="Tavern.mp3" loop></audio>
<audio id="fillSound" src="fill.mp3"></audio>

<div class="popup" id="popup">
  <div class="popup-content">
    <div id="popupText">Abmahnung</div>
    <button id="popupBtn">OK</button>
  </div>
</div>

<div class="gameover" id="gameover">Game Over<br>Du wurdest gek√ºndigt.<br>Du musst zum Arbeitsamt.</div>

<script>
const stage=document.getElementById("stage");
const moneyEl=document.getElementById("money");
const energyFill=document.getElementById("energyFill");
const bgm=document.getElementById("bgm");
const fillSound=document.getElementById("fillSound");
const popup=document.getElementById("popup");
const popupText=document.getElementById("popupText");
const popupBtn=document.getElementById("popupBtn");
const gameover=document.getElementById("gameover");

let money=0;
let energy=100;
let strikes=0;
let ended=false;
let goodFills=0;
let assistant=false;
let glasses=[];

// Roter Bereich gesch√§tzt
const AREA={xMin:25,xMax:75,yMin:55,yMax:85};
const GLASS_SIZE=46;
const MIN_DIST=50;

function euro(v){return v.toFixed(2).replace(".",",")+" ‚Ç¨";}
function updateMoney(){moneyEl.textContent=euro(money);}
function updateEnergy(){
  energyFill.style.width=energy+"%";
  if(energy>66)energyFill.style.background="green";
  else if(energy>33)energyFill.style.background="orange";
  else energyFill.style.background="red";
}

function spawnFx(txt,cls,x,y){
  const el=document.createElement("div");
  el.className="fx "+cls;
  el.textContent=txt;
  el.style.left=x+"px";
  el.style.top=y+"px";
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1000);
}

function randomPos(){
  let tries=0;
  while(tries<50){
    const x=AREA.xMin+(Math.random()*(AREA.xMax-AREA.xMin));
    const y=AREA.yMin+(Math.random()*(AREA.yMax-AREA.yMin));
    const sw=stage.clientWidth;
    const sh=stage.clientHeight;
    const px=sw*(x/100);
    const py=sh*(y/100);
    let overlap=false;
    for(const g of glasses){
      const rect=g.el.getBoundingClientRect();
      const gx=rect.left+rect.width/2;
      const gy=rect.top+rect.height/2;
      const dist=Math.hypot(px-gx,py-gy);
      if(dist<MIN_DIST){overlap=true;break;}
    }
    if(!overlap)return {px,py};
    tries++;
  }
  return {px:100,py:100};
}

function addGlass(){
  const {px,py}=randomPos();
  const el=document.createElement("div");
  el.className="glass";
  const fill=document.createElement("div");
  fill.className="fill";
  el.appendChild(fill);
  stage.appendChild(el);
  el.style.left=(px-GLASS_SIZE/2)+"px";
  el.style.top=(py-70/2)+"px";
  const g={el,fillEl:fill,pct:100,speed:Math.random()*2+3};
  el.addEventListener("click",()=>handleFill(g));
  glasses.push(g);
}

function handleFill(g){
  if(ended)return;
  fillSound.currentTime=0;fillSound.play();
  const prev=g.pct;
  g.pct=100;
  let add=0.25;
  let tip=0;
  let emoji="";
  if(prev<=33){emoji="üòÄ";tip=0.25*0.1;goodFills++;}
  else if(prev<=66){emoji="üòê";tip=0.25*0.05;}
  else{emoji="üò†";}
  if(assistant){add/=2;tip/=2;}
  money+=add+tip;
  updateMoney();
  const rect=g.el.getBoundingClientRect();
  const cx=rect.left+rect.width/2;
  const cy=rect.top;
  spawnFx("+"+euro(add),"money",cx-40,cy);
  if(tip>0)spawnFx("TIP +"+euro(tip),"tip",cx+40,cy);
  spawnFx(emoji,"emoji",cx,cy-20);
  checkUnlock();
}

function checkUnlock(){
  if(goodFills>0 && goodFills%3===0)addGlass();
}

function gameOver(){
  ended=true;
  gameover.style.display="flex";
}

function tick(dt){
  if(ended)return;
  for(const g of glasses){
    g.pct-=g.speed*dt;
    if(g.pct<=0){
      g.pct=0;
      strikes++;
      if(strikes>=3)gameOver();
      else{
        popupText.textContent=strikes===1?"Erste Abmahnung":"Zweite Abmahnung";
        popup.style.display="flex";
      }
    }
    g.fillEl.style.height=g.pct+"%";
  }
  energy-=0.005*dt*60;
  if(energy<=0)gameOver();
  updateEnergy();
}

let last=performance.now();
function loop(now){
  const dt=(now-last)/1000;last=now;
  tick(dt);
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// Buttons
document.getElementById("eatBtn").onclick=()=>{
  if(money>=1){money-=1;updateMoney();energy=Math.min(100,energy+20);}
};
document.getElementById("smokeBtn").onclick=()=>{
  if(money>=0.5){money-=0.5;updateMoney();energy=Math.min(100,energy+10);}
};
document.getElementById("drinkBtn").onclick=()=>{
  if(money>=0.7){money-=0.7;updateMoney();energy=Math.min(100,energy+15);}
};
document.getElementById("assistBtn").onclick=()=>{
  assistant=!assistant;
  document.getElementById("assistBtn").style.background=assistant?"rgba(0,128,0,0.5)":"rgba(0,0,0,0.5)";
};
document.getElementById("soundBtn").onclick=()=>{
  if(bgm.paused)bgm.play();else bgm.pause();
};
popupBtn.onclick=()=>popup.style.display="none";

// Init
updateMoney();
updateEnergy();
addGlass();
bgm.play().catch(()=>{});
</script>
</body>
</html>